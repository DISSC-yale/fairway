# Project Rules

## Apptainer Templates
- **Variable Definitions**: `Apptainer.def` templates MUST define necessary build variables (e.g., `SPARK_VERSION`, `HADOOP_VERSION`) within the `%post` section before they are used.
- **Single Source of Truth**: `src/fairway/templates.py` should read the `Apptainer.def` content from `src/fairway/data/Apptainer.def` using `_read_data_file` to ensure consistency.
- **Config Templates**: All default configuration files (e.g., `fairway.yaml`, `spark.yaml`) should be stored as templates in `src/fairway/data/` and loaded via `src/fairway/templates.py`.

## Version Consistency
- **Spark Version**: Ensure the Spark version is consistent across all configuration files:
    - `pyproject.toml`
    - `src/fairway/data/Apptainer.def`
    - `src/fairway/data/fairway-hpc.sh` (or generated scripts)

## Testing
- **Local Testing**: Run all tests using `pytest` from the project root.
    ```bash
    pytest tests/
    ```
- **Import Isolation**: Ensure the pipeline remains importable even if optional dependencies (like DuckDB) are missing.
    - Run the isolation test: `python tests/test_imports_isolation.py`
    - (Note: This is also covered by `pytest` but useful for verification in clean environments).
- **Environment**: Some tests (e.g., PySpark) require a compatible Java environment. If testing locally on a machine without Spark/Java properly configured, these tests may fail or be skipped.

## Filesystem Structure
- **Partitioned Data**: When generating partitioned data, the output path MUST be a directory without a file extension (e.g., `data/final/sales` rather than `data/final/sales.parquet`). The files inside will carry the appropriate extensions. This prevents confusion between single files and directories.

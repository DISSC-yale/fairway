Bootstrap: docker
From: python:3.10-slim-bookworm

%labels
    Author DISSC-Yale
    Version 1.0
    Description Fairway - Portable Data Ingestion Framework

%post
    # Fail fast on any error
    set -e

    apt-get update && apt-get install -y --no-install-recommends \
        git \
        curl \
        openjdk-17-jre-headless \
        procps \
        && rm -rf /var/lib/apt/lists/*

    # Install Nextflow
    curl -s https://get.nextflow.io | bash
    mv nextflow /usr/local/bin/
    chmod +x /usr/local/bin/nextflow

    # Install Spark
    SPARK_VERSION=3.5.1
    HADOOP_VERSION=3
    curl -sL "https://archive.apache.org/dist/spark/spark-${SPARK_VERSION}/spark-${SPARK_VERSION}-bin-hadoop${HADOOP_VERSION}.tgz" | tar -xz -C /opt
    ln -s /opt/spark-${SPARK_VERSION}-bin-hadoop${HADOOP_VERSION} /opt/spark

    # Install fairway and all dependencies from local source
    # This automatically handles pyproject.toml dependencies (including [all] extras)
    cd /app
    pip install --no-cache-dir ".[all]"

%environment
    export LC_ALL=C
    export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
    export SPARK_HOME=/opt/spark
    export PATH=$PATH:/opt/spark/bin:/usr/local/bin
    export PYTHONPATH=$PYTHONPATH:/app/src

%files
    src /app/src
    config /app/config
    main.nf /app/main.nf
    nextflow.config /app/nextflow.config
    pyproject.toml /app/pyproject.toml
    README.md /app/README.md

%runscript
    exec fairway "$@"

%help
    Fairway - A portable data ingestion framework for research data.

    Usage:
      # Run fairway commands
      apptainer run fairway.sif --help
      apptainer run fairway.sif run --config config/mydata.yaml

      # Interactive shell
      apptainer shell fairway.sif

      # Execute specific command
      apptainer exec fairway.sif fairway generate-schema data/raw/file.csv

    Building:
      apptainer build fairway.sif Apptainer.def

Bootstrap: docker
From: python:3.10-slim-bookworm

%labels
    Author DISSC-Yale
    Version 1.0
    Description Fairway - Portable Data Ingestion Framework

%files
    requirements.txt /opt/requirements.txt

%post
    # Fail fast on any error
    set -e

    apt-get update && apt-get install -y --no-install-recommends \
        git \
        curl \
        openjdk-17-jre-headless \
        procps \
        && rm -rf /var/lib/apt/lists/*
    
    # Install Nextflow
    curl -s https://get.nextflow.io | bash
    mv nextflow /usr/local/bin/
    chmod +x /usr/local/bin/nextflow
    
    # Install Spark
    SPARK_VERSION=3.5.1
    HADOOP_VERSION=3
    curl -sL "https://archive.apache.org/dist/spark/spark-${SPARK_VERSION}/spark-${SPARK_VERSION}-bin-hadoop${HADOOP_VERSION}.tgz" | tar -xz -C /opt
    ln -s /opt/spark-${SPARK_VERSION}-bin-hadoop${HADOOP_VERSION} /opt/spark
    
    # Install project dependencies
    if [ -f /opt/requirements.txt ]; then
        pip install --no-cache-dir -r /opt/requirements.txt
    else
        # Fallback: install fairway[all]
        pip install --no-cache-dir "git+https://github.com/DISSC-yale/fairway.git#egg=fairway[all]"
    fi

%environment
    export LC_ALL=C
    export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
    export SPARK_HOME=/opt/spark
    export PATH=$PATH:/opt/spark/bin:/usr/local/bin

%runscript
    exec fairway "$@"

%help
    Fairway - A portable data ingestion framework for research data.
    
    Usage:
      apptainer run fairway.sif --help
      apptainer run fairway.sif run --config config/mydata.yaml
      apptainer exec fairway.sif fairway generate-schema data/raw/file.csv
    
    Building:
      apptainer build fairway.sif Apptainer.def
